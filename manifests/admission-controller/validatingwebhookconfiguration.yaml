apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: sysdig-admission-controller
  annotations:
    argocd.argoproj.io/sync-wave: "5"
  labels:
    app.kubernetes.io/name: sysdig-admission-controller
    app.kubernetes.io/component: admission-controller
    app.kubernetes.io/part-of: sysdig-shield
webhooks:
- name: scanning.admission.sysdig.com
  admissionReviewVersions:
  - v1
  - v1beta1

  # Client configuration - points to admission controller service
  clientConfig:
    service:
      name: sysdig-admission-controller
      namespace: sysdig-shield
      path: /validate
      port: 443
    # CA bundle will be injected by cert-manager or manually
    caBundle: ""  # Placeholder - must be populated

  # Failure policy - Ignore for initial rollout, change to Fail after validation
  failurePolicy: Ignore

  # Match policy
  matchPolicy: Equivalent

  # Namespace selector - exclude system namespaces
  namespaceSelector:
    matchExpressions:
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - kube-system
      - kube-public
      - kube-node-lease
      - sysdig-shield

  # Rules - intercept pod create/update operations
  rules:
  - apiGroups:
    - ""
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - pods
    scope: Namespaced
  - apiGroups:
    - apps
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - deployments
    - daemonsets
    - statefulsets
    - replicasets
    scope: Namespaced
  - apiGroups:
    - batch
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - jobs
    - cronjobs
    scope: Namespaced

  # Side effects
  sideEffects: None

  # Timeout in seconds
  timeoutSeconds: 10
